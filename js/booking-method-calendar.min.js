function bookacti_set_calendar_up(a,h){h=h?1:0;var j=a.attr("id");var d=a.find(".bookacti-calendar:first");bookacti.booking_system[j]["load_events"]=false;d.fullCalendar({header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},locale:bookacti_localized.fullcalendar_locale,defaultView:d.width()<bookacti_localized.default_view_threshold?"agendaDay":"agendaWeek",weekNumbersWithinDays:1,allDaySlot:false,allDayDefault:false,fixedWeekCount:false,contentHeight:"auto",editable:false,droppable:false,eventDurationEditable:false,showNonCurrentDates:false,eventLimit:2,eventLimitClick:"popover",dragRevertDuration:0,slotLabelFormat:"LT",slotDuration:"00:30",minTime:"08:00",maxTime:"20:00",views:{week:{eventLimit:false},day:{eventLimit:false},listDay:{buttonText:bookacti_localized.calendar_button_list_day},listWeek:{buttonText:bookacti_localized.calendar_button_list_week},listMonth:{buttonText:bookacti_localized.calendar_button_list_month},listYear:{buttonText:bookacti_localized.calendar_button_list_year},agendaFlexible:{type:"agenda",buttonText:bookacti_localized.calendar_button_flexible},basicFlexible:{type:"basic",buttonText:bookacti_localized.calendar_button_flexible},listFlexible:{type:"list",buttonText:bookacti_localized.calendar_button_flexible},basicMonthMultiple:{type:"basic",duration:{months:bookacti_localized.multiple_months_view_duration},fixedWeekCount:false,buttonText:bookacti_localized.calendar_button_multiple_months.replace("{months}",bookacti_localized.multiple_months_view_duration)},listMonthMultiple:{type:"list",duration:{months:bookacti_localized.multiple_months_view_duration},fixedWeekCount:false,buttonText:bookacti_localized.calendar_button_multiple_months.replace("{months}",bookacti_localized.multiple_months_view_duration)}},events:function(n,k,l,m){m([])},viewRender:function(k){if(bookacti.booking_system[j]["load_events"]===true){var l={start:moment.utc(k.intervalStart),end:moment.utc(k.intervalEnd).subtract(1,"days")};bookacti_fetch_events_from_interval(a,l)}},eventRender:function(k,p,r){p.data("event-id",k.id);p.attr("data-event-id",k.id);p.data("event-start",k.start.format("YYYY-MM-DD HH:mm:ss"));p.attr("data-event-start",k.start.format("YYYY-MM-DD HH:mm:ss"));p.data("event-end",k.end.format("YYYY-MM-DD HH:mm:ss"));p.attr("data-event-end",k.end.format("YYYY-MM-DD HH:mm:ss"));p.data("activity-id",bookacti.booking_system[j]["events_data"][k.id]["activity_id"]);p.attr("data-activity-id",bookacti.booking_system[j]["events_data"][k.id]["activity_id"]);k.render=1;var s=p.find(".fc-title");s.html(s.text());var l="LT";if(r.name.indexOf("agenda")>-1){l=d.fullCalendar("option","noMeridiemTimeFormat")}p.find(".fc-time").html('<span class="bookacti-event-time-start">'+k.start.format(l)+'</span><span class="bookacti-event-time-separator"> - </span><span class="bookacti-event-time-end">'+k.end.format(l)+"</span>");if(bookacti_get_event_number_of_bookings(a,k)!=null){var m=bookacti.booking_system[j]["bookings_only"]==1?true:false;var q="";if(m){q=bookacti_get_event_number_of_bookings_div(a,k)}else{var n=bookacti_is_event_available(a,k);if(!n){p.addClass("bookacti-event-unavailable")}q=bookacti_get_event_availability_div(a,k)}p.append(q)}if(r.name==="month"||r.name==="basicWeek"||r.name==="basicDay"){var o=$j("<div />",{"class":"fc-bg"});p.append(o)}a.trigger("bookacti_event_render",[k,p,r]);if(!k.render){return false}},eventAfterRender:function(m,l,k){bookacti_add_class_according_to_event_size(l)},eventAfterAllRender:function(k){$j.each(bookacti.booking_system[j]["picked_events"],function(l,m){d.find('.fc-event[data-event-id="'+m.id+'"][data-event-start="'+m.start+'"]').addClass("bookacti-picked-event")});bookacti_refresh_picked_events_on_calendar(a)},eventClick:function(m,l,k){bookacti_event_click(a,m)}});bookacti_update_calendar_settings(a);var g=d.fullCalendar("getView");var b={start:moment.utc(g.start),end:moment.utc(g.end).subtract(1,"days")};var e=false;if(typeof bookacti.booking_system[j]["events_interval"]!=="undefined"){var c=moment.utc(bookacti.booking_system[j]["events_interval"]["start"]);var f=moment.utc(bookacti.booking_system[j]["events_interval"]["end"]);if(c.isAfter(b.start)||f.isBefore(b.end)){e=true}}if((!h||e)&&typeof bookacti.booking_system[j]["events"]!=="undefined"){if(bookacti.booking_system[j]["events"].length){bookacti_display_events_on_calendar(a)}}if(h||e){bookacti_fetch_events_from_interval(a,b)}d.off("click",".fc-more").on("click",".fc-more",function(){bookacti_refresh_picked_events_on_calendar(a)});a.off("bookacti_pick_event").on("bookacti_pick_event",function(l,k){bookacti_pick_event_on_calendar($j(this),k)});a.off("bookacti_unpick_event").on("bookacti_unpick_event",function(m,l,k){bookacti_unpick_event_on_calendar($j(this),l,k)});a.off("bookacti_unpick_all_events").on("bookacti_unpick_all_events",function(){bookacti_unpick_all_events_on_calendar($j(this))});bookacti.booking_system[j]["load_events"]=true;var i=bookacti.booking_system[j]["picked_events"];if(!$j.isEmptyObject(bookacti.booking_system[j]["picked_events"])){d.fullCalendar("gotoDate",moment(i[0]["start"]))}a.trigger("bookacti_after_calendar_set_up")}function bookacti_display_events_on_calendar(b,c){var a=b.attr("id");var d=b.find(".bookacti-calendar:first");c=typeof c==="undefined"?bookacti.booking_system[a]["events"]:c;d.fullCalendar("addEventSource",c)}function bookacti_clear_events_on_calendar(a,b){b=b||null;var c=null;var d=a.hasClass("fc")?a:a.find(".fc");if(b!==null){if(b._id!==undefined){if(b._id.indexOf("_")>=0){d.fullCalendar("removeEvents",b._id)}}d.fullCalendar("removeEvents",b.id);c=b.id}else{d.fullCalendar("removeEvents")}return c}function bookacti_display_event_source_on_calendar(a,b){var c=a.hasClass("fc")?a:a.find(".bookacti-calendar:first");c.fullCalendar("addEventSource",b)}function bookacti_pick_event_on_calendar(a,c){var d=c.start instanceof moment?c.start.format("YYYY-MM-DD HH:mm:ss"):c.start;var b=a.find('.fc-event[data-event-id="'+c.id+'"][data-event-start="'+d+'"]');b.addClass("bookacti-picked-event")}function bookacti_unpick_event_on_calendar(a,c,b){var e=c.start instanceof moment?c.start.format("YYYY-MM-DD HH:mm:ss"):c.start;var d=a.find('.fc-event[data-event-id="'+c.id+'"]');if(!b&&c.start){d=a.find('.fc-event[data-event-id="'+c.id+'"][data-event-start="'+e+'"]')}d.removeClass("bookacti-picked-event")}function bookacti_unpick_all_events_on_calendar(a){a.find(".bookacti-picked-event").removeClass("bookacti-picked-event")}function bookacti_refresh_picked_events_on_calendar(b){var a=b.attr("id");bookacti_unpick_all_events_on_calendar(b);$j.each(bookacti.booking_system[a]["picked_events"],function(d,e){var c=b.find('.fc-event[data-event-id="'+e.id+'"][data-event-start="'+e.start+'"]');c.addClass("bookacti-picked-event")});b.trigger("bookacti_refresh_picked_events_on_calendar")}function bookacti_get_first_and_last_events_on_calendar(c){var b=c.fullCalendar("getEventSources");var a={first:false,last:false};if(!b.length){return a}$j.each(b,function(e,d){if(typeof d.rawEventDefs==="undefined"||d.rawEventDefs.length===0){return true}var f=d.rawEventDefs;if(d.id.substr(0,8)==="activity"){f=bookacti_sort_events_array_by_dates(f)}if(!a.first||(a.first&&moment(f[0].start).isBefore(a.first.start))){a.first=f[0]}if(d.id.substr(0,8)==="activity"){f=bookacti_sort_events_array_by_dates(f,true)}if(!a.last||(a.last&&moment(f[f.length-1].end).isAfter(a.last.end))){a.last=f[f.length-1]}});return a}function bookacti_add_class_according_to_event_size(a){var b=bookacti.event_sizes;$j(a).trigger("bookacti_event_sizes",[a,b]);if($j(a).innerHeight()<b.tiny_height){a.addClass("bookacti-tiny-event").removeClass("bookacti-small-event")}if($j(a).innerHeight()<b.small_height){a.addClass("bookacti-small-event").removeClass("bookacti-tiny-event")}if($j(a).innerWidth()<b.narrow_width){a.addClass("bookacti-narrow-event").removeClass("bookacti-wide-event")}if($j(a).innerWidth()>b.wide_width){a.addClass("bookacti-wide-event").removeClass("bookacti-narrow-event");a.removeClass("fc-short")}}function bookacti_update_calendar_settings(c){var g=c.find(".fc").addBack(".fc").first();if(!g.data("fullCalendar")){return false}var e={};var b=c.attr("id");var d=bookacti.booking_system[b]["template_data"];var f=$j.extend(true,{},d.settings);var a=bookacti_get_availability_period(c);if(d.start&&d.end){e.validRange={start:moment(a.start),end:moment(a.end).add(1,"days")}}if(f.minTime){e.minTime=f.minTime}if(f.maxTime){e.maxTime=f.maxTime==="00:00"?"24:00":f.maxTime}if(f.snapDuration){e.snapDuration=f.snapDuration}g.trigger("bookacti_before_update_calendar_settings",[e,f]);if(!$j.isEmptyObject(e)){g.fullCalendar("option",e)}g.trigger("bookacti_calendar_settings_updated",[e,f])}function bookacti_enter_calendar_loading_state(a){a.find(".fc-toolbar button").addClass("fc-state-disabled").attr("disabled",true);bookacti_append_loading_overlay(a.find(".fc-view-container"))}function bookacti_exit_calendar_loading_state(a){a.find(".fc-toolbar button").removeClass("fc-state-disabled").attr("disabled",false);bookacti_remove_loading_overlay(a.find(".fc-view-container"))}function bookacti_append_loading_overlay(a){a.append('<div class="bookacti-loading-overlay" ><div class="bookacti-loading-content" ><div class="bookacti-loading-box" ><div class="bookacti-loading-image" ><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /></div><div class="bookacti-loading-text" >'+bookacti_localized.loading+"</div></div></div></div>").css("position","relative")}function bookacti_remove_loading_overlay(a){a.find(".bookacti-loading-overlay").remove().css("position","static")};