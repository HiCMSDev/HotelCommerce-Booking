$j(document).ready(function(){if($j(".bookacti-booking-action").length||$j(".bookacti-booking-group-action").length){bookacti_init_bookings_dialogs();bookacti_init_booking_actions()}});function bookacti_init_bookings_dialogs(){$j(".bookacti-bookings-dialog").dialog({modal:true,autoOpen:false,minHeight:300,minWidth:440,resize:"auto",show:true,hide:true,closeText:"&#10006;",close:function(){}});$j("#bookacti-cancel-booking-dialog").dialog({title:bookacti_localized.booking_action_cancel});$j("#bookacti-reschedule-booking-dialog").dialog({title:bookacti_localized.booking_action_reschedule});$j("#bookacti-refund-booking-dialog").dialog({title:bookacti_localized.booking_action_refund});$j("#bookacti-refund-booking-confirm-dialog").dialog({title:bookacti_localized.booking_confirm_refund});$j("#bookacti-change-booking-state-dialog").dialog({title:bookacti_localized.booking_change_state})}function bookacti_dialog_cancel_booking(a,b){b=b==="group"?"group":"single";var c=b==="group"?"bookactiCancelBookingGroup":"bookactiCancelBooking";$j("#bookacti-cancel-booking-dialog").dialog("open");$j("#bookacti-cancel-booking-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}},{text:bookacti_localized.dialog_button_cancel_booking,"class":"bookacti-dialog-delete-button",click:function(){if(b==="single"){var f=$j('.bookacti-cancel-booking[data-booking-id="'+a+'"]').parents("tr");var d=$j('.bookacti-cancel-booking[data-booking-id="'+a+'"]').parents(".bookacti-booking-actions");var e=f.parents("#bookacti-bookings-list").length?1:0}else{var f=$j('.bookacti-cancel-booking-group[data-booking-group-id="'+a+'"]').parents("tr");var d=$j('.bookacti-cancel-booking-group[data-booking-group-id="'+a+'"]').parents(".bookacti-booking-group-actions")}var e=f.parents("#bookacti-bookings-list").length?1:0;bookacti_booking_row_enter_loading_state(f);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:c,booking_id:a,is_bookings_page:e,nonce:bookacti_localized.nonce_cancel_booking},dataType:"json",success:function(h){if(h.status==="success"){d.html(h.new_actions_html);f.find(".bookacti-booking-state").removeClass("bookacti-booking-state-good bookacti-booking-state-warning bookacti-booking-state-bad").addClass("bookacti-booking-state-bad").html(bookacti_localized.cancelled);if(h.allow_refund){bookacti_dialog_refund_booking(a,b)}$j("body").trigger("bookacti_booking_cancelled",[a,e])}else{if(h.status==="failed"){var g=bookacti_localized.error_cancel_booking;if(h.error==="not_allowed"){g+="\n"+bookacti_localized.error_not_allowed}console.log(g);console.log(h)}}},error:function(g){console.log("AJAX "+bookacti_localized.error_cancel_booking);console.log(g)},complete:function(){bookacti_booking_row_exit_loading_state(f)}});$j(this).dialog("close")}}])}function bookacti_dialog_refund_booking(a,d){d=d==="group"?"group":"single";var e=d==="group"?"bookactiGetBookingGroupRefundActionsHTML":"bookactiGetBookingRefundActionsHTML";var b=d==="group"?"bookactiRefundBookingGroup":"bookactiRefundBooking";var c=[{text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}}];$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:e,booking_id:a,nonce:bookacti_localized.nonce_get_refund_actions_html},dataType:"json",success:function(g){if(g.status==="success"){$j("#bookacti-refund-booking-dialog").html(g.actions_html);if(!$j.isEmptyObject(g.actions_array)){$j('#bookacti-refund-options input[type="radio"]:first').attr("checked",true);var h=$j("<div />",{id:"bookacti-refund-message"});var i=$j("<strong />",{text:bookacti_localized.ask_for_reasons});var j=$j("<textarea />",{name:"refund-message"});h.append(i);h.append(j);$j("#bookacti-refund-options").after(h);c.push({text:bookacti_localized.dialog_button_refund,click:function(){if(d==="single"){var p=$j('.bookacti-refund-booking[data-booking-id="'+a+'"]').parents("tr");var k=$j('.bookacti-refund-booking[data-booking-id="'+a+'"]').parents(".bookacti-booking-actions")}else{var p=$j('.bookacti-refund-booking-group[data-booking-group-id="'+a+'"]').parents("tr");var k=$j('.bookacti-refund-booking-group[data-booking-group-id="'+a+'"]').parents(".bookacti-booking-group-actions")}var n='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";p.find(".bookacti-booking-state").hide();p.find(".bookacti-booking-state").after(n);var o=$j('#bookacti-refund-options input[name="refund-action"]:checked').val();var m=$j('#bookacti-refund-message textarea[name="refund-message"]').val();var l=$j("#bookacti-refund-options #nonce_refund_booking").val();$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:b,booking_id:a,refund_action:o,refund_message:m,is_admin:bookacti_localized.is_admin,nonce:l},dataType:"json",success:function(r){if(r.status==="success"){var s={message:"",new_status:bookacti_localized.refunded};if(o==="email"){s.message+=bookacti_localized.advice_refund_request_email_sent;s.new_status=bookacti_localized.refund_requested}$j("body").trigger("bookacti_booking_refunded",[a,d,o,m,s,r]);k.html(r.new_actions_html);var t=p.find(".bookacti-booking-state").parent();p.find(".bookacti-booking-state").remove();t.append(r.formatted_state);bookacti_dialog_refund_confirmation(s.message)}else{if(r.status==="failed"){var q=bookacti_localized.error_refund_booking;if(r.error==="not_allowed"){q+="\n"+bookacti_localized.error_not_allowed}else{if(r.error){q+="\n"+r.error}else{if(r.message){q+="\n"+r.message}}}console.log(q);console.log(r)}}},error:function(q){console.log("AJAX "+bookacti_localized.error_refund_booking);console.log(q)},complete:function(){p.find(".bookacti-loading-alt").remove();p.find(".bookacti-booking-state").show()}});$j(this).dialog("close")}})}$j("#bookacti-refund-booking-dialog").dialog("option","buttons",c);$j("#bookacti-refund-booking-dialog").dialog("open")}else{if(g.status==="failed"){var f=bookacti_localized.error_get_refund_booking_actions;if(g.error==="not_allowed"){f+="\n"+bookacti_localized.error_not_allowed}console.log(f);console.log(g)}}},error:function(f){console.log("AJAX "+bookacti_localized.error_refund_booking);console.log(f)},complete:function(){}})}function bookacti_dialog_refund_confirmation(a){$j("#bookacti-refund-booking-confirm-dialog").html(a);$j("#bookacti-refund-booking-confirm-dialog").dialog("open");$j("#bookacti-refund-booking-confirm-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){$j(this).dialog("close")}}])}function bookacti_dialog_change_booking_state(b,c){c=c==="group"?"group":"single";var e=c==="group"?"bookactiChangeBookingGroupState":"bookactiChangeBookingState";$j("#bookacti-change-booking-state-dialog").dialog("open");$j("#bookacti-select-booking-state option").attr("disabled",false);var f=$j('.bookacti-change-booking-state[data-booking-id="'+b+'"]').parents("tr");if(c==="single"){var f=$j('.bookacti-change-booking-state[data-booking-id="'+b+'"]').parents("tr");var a=$j('.bookacti-change-booking-state[data-booking-id="'+b+'"]').parents(".bookacti-booking-actions")}else{var f=$j('.bookacti-change-booking-group-state[data-booking-group-id="'+b+'"]').parents("tr");var a=$j('.bookacti-change-booking-group-state[data-booking-group-id="'+b+'"]').parents(".bookacti-booking-group-actions")}var d=f.find(".bookacti-booking-state").data("booking-state");if(d){$j('#bookacti-select-booking-state option[value="'+d+'"]').attr("disabled",true)}$j("#bookacti-change-booking-state-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}},{text:bookacti_localized.dialog_button_ok,click:function(){var j=f.parents("#bookacti-bookings-list").length?1:0;var h=$j("select#bookacti-select-booking-state").val();var g=$j("#bookacti-send-notifications-on-state-change").prop("checked")?1:0;var i=$j("#bookacti-change-booking-state-dialog #nonce_change_booking_state").val();if(h&&h!==d){bookacti_booking_row_enter_loading_state(f);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:e,booking_id:b,new_state:h,send_notifications:g,is_bookings_page:j,nonce:i},dataType:"json",success:function(l){if(l.status==="success"){a.html(l.new_actions_html);f.find(".bookacti-booking-state").parent().html(l.formatted_state);if(j&&l.active_changed){var m=bookacti.booking_system["bookacti-booking-system-bookings-page"]["method"];bookacti_booking_method_refetch_events($j("#bookacti-booking-system-bookings-page"),m)}$j("body").trigger("bookacti_booking_state_changed",[b,c,h,j])}else{if(l.status==="failed"){var k=bookacti_localized.error_change_booking_state;if(l.error==="not_allowed"){k+="\n"+bookacti_localized.error_not_allowed}if(typeof l.message!=="undefined"){k+="\n"+l.message}console.log(k);console.log(l)}}},error:function(k){console.log("AJAX "+bookacti_localized.error_change_booking_state);console.log(k)},complete:function(){bookacti_booking_row_exit_loading_state(f)}});$j(this).dialog("close")}}}])}function bookacti_dialog_reschedule_booking(a){var d=$j('.bookacti-booking-action[data-booking-id="'+a+'"]').parents("tr");var b=$j("#bookacti-booking-system-reschedule.bookacti-booking-system");var c=0;bookacti_booking_row_enter_loading_state(d);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingData",booking_id:a,nonce:bookacti_localized.nonce_get_booking_data},dataType:"json",success:function(h){if(h.status==="success"){bookacti_clear_booking_system_displayed_info(b);var g=b.attr("id");var f=h.booking_data.template_id;var i=h.booking_data.activity_id;c=h.booking_data.quantity;bookacti.booking_system[g]["calendars"]=f?[f]:[];bookacti.booking_system[g]["activities"]=i?[i]:[];b.trigger("bookacti_before_reschedule_booking_system_loads",[h.booking_data]);bookacti_reload_booking_system(b);$j("#bookacti-reschedule-booking-dialog").dialog("open")}else{if(h.status==="failed"){var e=bookacti_localized.error_retrieve_booking_system;if(h.error==="not_allowed"){e+="\n"+bookacti_localized.error_not_allowed}console.log(e);console.log(h)}}},error:function(f){console.log("AJAX "+bookacti_localized.error_retrieve_booking_system);console.log(f)},complete:function(){bookacti_booking_row_exit_loading_state(d)}});$j("#bookacti-reschedule-booking-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_reschedule,"class":"bookacti-dialog-delete-button",click:function(){var h=b.parent().find('input[name="bookacti_event_id"]').val();var g=b.parent().find('input[name="bookacti_event_start"]').val();var f=b.parent().find('input[name="bookacti_event_end"]').val();var j=bookacti_validate_picked_events(b,c);if(j){var i=bookacti_localized.is_admin?1:0;var e=1;if(i&&$j("#bookacti-send-notifications-on-reschedule").length){e=$j("#bookacti-send-notifications-on-reschedule").prop("checked")?1:0}bookacti_booking_row_enter_loading_state(d);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiRescheduleBooking",booking_id:a,event_id:h,event_start:g,event_end:f,is_bookings_page:i,send_notifications:e,nonce:bookacti_localized.nonce_reschedule_booking},dataType:"json",success:function(k){if(k.status==="success"){$j("#bookacti-reschedule-booking-dialog").dialog("close");if(i){d.remove();$j("#bookacti-booking-system-bookings-page .bookacti-calendar").fullCalendar("removeEvents");bookacti_fetch_events($j("#bookacti-booking-system-bookings-page"))}$j("body").trigger("bookacti_booking_rescheduled",[a,g,f,k])}else{if(k.error==null){console.log(bookacti_localized.error_reschedule_booking);console.log(k)}b.siblings(".bookacti-notices").html("<ul class='bookacti-error-list'><li>"+k.message+"</li></ul>").show()}},error:function(k){console.log("AJAX "+bookacti_localized.error_reschedule_booking);console.log(k)},complete:function(){bookacti_booking_row_exit_loading_state(d)}})}}},{text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}}])};