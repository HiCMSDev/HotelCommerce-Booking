$j(document).ready(function(){bookacti_init_form_dialogs();$j("body").on("keyup",".bookacti-booking-form input[name=password]",function(g){var c=$j(this);var a=null;var d=$j(this).parents(".bookacti-form-field-container").find(".bookacti-password-strength-meter");var f=[];var b=bookacti_check_password_strength(c,a,d,f);$j(this).parents(".bookacti-form-field-container").find("input[name=password_strength]").val(b)});$j("body").on("click",".bookacti-forgotten-password-link",function(b){b.preventDefault();var a=$j(this).data("field-id");bookacti_dialog_forgotten_password(a)});$j("body").on("change",".bookacti-new_account",function(c){var d=$j(this).parents(".bookacti-form-field-container").find(".bookacti-password-strength");var a=$j(this).parents(".bookacti-form-field-container").find(".bookacti-generated-password");var b=$j(this).parents(".bookacti-form-field-login-field-container").find("fieldset.bookacti-register-fields");if($j(this).is(":checked")){d.show();a.hide();a.find(".bookacti-required-field").prop("required",false);b.show();b.find(".bookacti-required-field").prop("required",true)}else{d.hide();a.show();a.find(".bookacti-required-field").prop("required",true);b.hide();b.find(".bookacti-required-field").prop("required",false)}});$j(".bookacti-booking-form").on("submit",function(b){b.preventDefault();var a=$j(this);bookacti_sumbit_booking_form(a)});$j(".bookacti-booking-form").on("click",".bookacti-new-booking-button",function(){if($j(this).hasClass("bookacti-reload-page")){window.location.reload(true);$j(this).prop("disabled",true);return}var b=$j(this).parents("form");var a=b.find(".bookacti-booking-system");bookacti_clear_booking_system_displayed_info(a);b.find("> .bookacti-notices").empty();b.find('.bookacti-form-field-container, input[type="submit"]').show();$j(this).remove();b.trigger("bookacti_make_new_booking")});$j(".bookacti-booking-form").on("keyup mouseup","input.bookacti-quantity",function(){var a=$j(this).parents("form").find(".bookacti-booking-system");if(a.length){bookacti_fill_picked_events_list(a)}});$j(".bookacti-booking-form").on("bookacti_picked_events_list_data",".bookacti-booking-system",function(f,b,d){var a=$j(this);var c=a.parents("form").find("input.bookacti-quantity");if(c.length){bookacti_set_min_and_max_quantity(a,c,b)}});$j(".bookacti-booking-form .bookacti-booking-system").on("bookacti_view_refreshed bookacti_displayed_info_cleared",function(b){var a=$j(this).parents("form");a.find('input[name="quantity"]').attr("disabled",false);a.find('button[type="submit"]').attr("disabled",false)});$j(".bookacti-booking-form .bookacti-booking-system").on("bookacti_error_displayed",function(b){var a=$j(this).parents("form");a.find('input[name="quantity"]').attr("disabled",true);a.find('button[type="submit"]').attr("disabled",true)})});function bookacti_init_form_dialogs(){$j(".bookacti-form-dialog").dialog({modal:true,autoOpen:false,minHeight:300,minWidth:440,resize:"auto",show:true,hide:true,dialogClass:"bookacti-dialog",closeText:"&#10006;",beforeClose:function(){if(!bookacti_localized.is_admin){return}var b=".bookacti-form-dialog";var a=$j(this).attr("id");if(a){b="#"+a}bookacti_empty_all_dialog_forms(b)}});$j(".ui-widget-overlay").live("click",function(){$j("div:ui-dialog:visible").dialog("close")});$j(".bookacti-form-dialog").on("keydown",function(a){if(!$j("textarea").is(":focus")&&a.keyCode==$j.ui.keyCode.ENTER){$j(this).parent().find(".ui-dialog-buttonpane button:first").focus();return false}})}function bookacti_check_password_strength(d,b,e,f){var g=d.val();var a=b!=null?b.val():g;f=f.concat(wp.passwordStrength.userInputBlacklist());d.removeClass("short bad good strong");e.removeClass("short bad good strong");var c=wp.passwordStrength.meter(g,f,a);switch(c){case 2:d.addClass("bad");e.addClass("bad").html(pwsL10n.bad);break;case 3:d.addClass("good");e.addClass("good").html(pwsL10n.good);break;case 4:d.addClass("strong");e.addClass("strong").html(pwsL10n.strong);break;case 5:d.addClass("short");e.addClass("short").html(pwsL10n.mismatch);break;default:d.addClass("short");e.addClass("short").html(pwsL10n["short"])}return c}function bookacti_sumbit_booking_form(c){var a=c.find(".bookacti-booking-system");c.find('input[type="submit"]').prop("disabled",true);var b=false;if(typeof bookacti_localized.current_user_id!=="undefined"){if(bookacti_localized.current_user_id){b=true}}var f=true;if(c.find(".bookacti-email").length&&c.find(".bookacti-password").length){if(c.find(".bookacti-email").val()!=""&&c.find(".bookacti-password").val()!=""){f=false}}if(!b&&f){c.find("> .bookacti-notices").empty().append("<ul class='bookacti-error-list'><li>"+bookacti_localized.error_user_not_logged_in+"</li></ul>").show();c.find('input[type="submit"]').prop("disabled",false);return false}if(!f){if(c.find(".bookacti-new_account").is(":checked")&&!c.find(".bookacti-generated-password").length&&parseInt(c.find(".bookacti-password_strength").val())<parseInt(c.find(".bookacti-password_strength").attr("min"))){c.find("> .bookacti-notices").empty().append("<ul class='bookacti-error-list'><li>"+bookacti_localized.error_password_not_strong_enough+"</li></ul>").show();c.find('input[type="submit"]').prop("disabled",false);return false}}var e=bookacti_validate_picked_events(a,c.find(".bookacti-quantity").val());if(!e){bookacti_scroll_to(a.siblings(".bookacti-notices"),500,"middle");c.find('input[type="submit"]').prop("disabled",false);return false}c.trigger("bookacti_before_submit_booking_form");var d=c.serializeObject();bookacti_start_loading_booking_system(a);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:d,dataType:"json",success:function(g){var h="";if(g.status!=="success"){h="<ul class='bookacti-error-list'><li>"+g.message+"</li></ul>"}else{c.find('.bookacti-form-field-container:not(.bookacti-form-field-name-submit):not(.bookacti-form-field-name-calendar), input[type="submit"]').hide();var i="";if(g.has_logged_in||g.has_registered){i="bookacti-reload-page"}c.find(".bookacti-form-field-name-submit").append('<input type="button" class="bookacti-new-booking-button '+i+'" value="'+bookacti_localized.booking_form_new_booking_button+'" />');h="<ul class='bookacti-success-list bookacti-persistent-notice'><li>"+g.message+"</li></ul>";if(c.attr("action")===""){bookacti_refresh_booking_numbers(a)}}if(typeof g.nonce!=="undefined"){if(g.nonce){c.find('input[name="nonce_booking_form"]').val(g.nonce)}}if(h){c.find("> .bookacti-notices").empty().append(h).show();bookacti_scroll_to(c.find("> .bookacti-notices"),500,"middle")}c.trigger("bookacti_booking_form_submitted",[g,d]);if(g.status==="success"&&c.attr("action")!==""){window.location.replace(c.attr("action"))}},error:function(h){var g="<ul class='bookacti-error-list'><li>AJAX "+bookacti_localized.error_book+"</li></ul>";c.find("> .bookacti-notices").empty().append(g).show();bookacti_scroll_to(c.find("> .bookacti-notices"),500,"middle");console.log("AJAX "+bookacti_localized.error_book);console.log(h)},complete:function(){bookacti_stop_loading_booking_system(a);c.find('input[type="submit"]').prop("disabled",false)}})}function bookacti_dialog_forgotten_password(b){var c=$j('.bookacti-forgotten-password-link[data-field-id="'+b+'"]');var a=$j('.bookacti-forgotten-password-dialog[data-field-id="'+b+'"]');if(!a.length){a=$j(".bookacti-forgotten-password-dialog:first")}a.dialog("open");a.dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){a.find(".bookacti-loading-alt, .bookacti-notices").remove();var d=a.find(".bookacti-forgotten-password-email").val();var e=a.find(".bookacti-nonce-forgotten-password").val();if(!d||!e){return}var f='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";a.append(f);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiForgottenPassword",email:d,nonce:e},dataType:"json",success:function(h){if(h.status==="success"){if(typeof h.message!=="undefined"){a.append('<div class="bookacti-notices"><ul class="bookacti-success-list"><li>'+h.message+"</li></ul></div>")}$j("body").trigger("bookacti_forgotten_password_email_sent",[d,h])}else{if(h.status==="failed"){var g=bookacti_localized.error_send_email;if(h.error==="not_allowed"){g+="<br/>"+bookacti_localized.error_not_allowed}if(typeof h.message!=="undefined"){g=h.message}a.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+g+"</li></ul></div>");console.log(h)}}},error:function(g){a.append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error_send_email+"</li></ul></div>");console.log(g)},complete:function(){a.find(".bookacti-notices").show();a.find(".bookacti-loading-alt").remove()}})}}])};