$j(document).ready(function(){if($j("#bookacti-template-calendar").length||$j("#bookacti-first-template-container").length){bookacti.booking_system["bookacti-template-calendar"]=[];bookacti.booking_system["bookacti-template-calendar"]["bookings"]=[];bookacti.booking_system["bookacti-template-calendar"]["exceptions"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["activities_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["group_categories_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["settings"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=0;bookacti.booking_system["bookacti-template-calendar"]["past_events"]=true;bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];bookacti.selected_template=parseInt($j("#bookacti-template-picker").val())||0;bookacti.selected_category="new";bookacti.is_dragging=false;bookacti.blocked_events=false;bookacti_init_activities();bookacti_init_groups_of_events();bookacti_init_show_hide_activities_switch();bookacti_init_show_hide_groups_switch();bookacti_init_template_dialogs();bookacti_bind_template_dialogs();$j("#bookacti-template-picker").on("change",function(){bookacti_switch_template($j(this).val())});if($j("#bookacti-template-calendar").length){bookacti_load_template_calendar()}if(bookacti.selected_template){bookacti_switch_template(bookacti.selected_template)}window.onerror=function(e,b,a,d,c){$j("#bookacti-fatal-error").show()};$j("#bookacti-exit-loading").on("click",function(){bookacti_exit_template_loading_state(true)})}});function bookacti_load_template_calendar(){var a=$j("#bookacti-template-calendar");a.fullCalendar({locale:bookacti_localized.current_lang_code,defaultView:"agendaWeek",minTime:"08:00",maxTime:"20:00",slotDuration:"00:30",snapDuration:"00:30",scrollTime:"08:00",nowIndicator:0,weekNumbers:0,weekNumbersWithinDays:1,navLinks:0,slotEventOverlap:0,eventLimit:2,eventLimitClick:"popover",showNonCurrentDates:0,allDaySlot:false,allDayDefault:false,fixedWeekCount:false,showNonCurrentDates:false,editable:true,droppable:true,dropAccept:".fc-event",eventDurationEditable:false,dragRevertDuration:0,views:{week:{eventLimit:false},day:{eventLimit:false},listDay:{buttonText:bookacti_localized.calendar_button_list_day},listWeek:{buttonText:bookacti_localized.calendar_button_list_week},listMonth:{buttonText:bookacti_localized.calendar_button_list_month},listYear:{buttonText:bookacti_localized.calendar_button_list_year}},header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},validRange:{start:moment($j("#bookacti-template-picker :selected").data("template-start")),end:moment($j("#bookacti-template-picker :selected").data("template-end")).add(1,"days")},events:function(e,b,c,d){d([])},viewRender:function(b){if(b.name==="agendaWeek"||b.name==="agendaDay"){a.fullCalendar("option","contentHeight","auto")}else{a.fullCalendar("option","contentHeight",null)}},eventRender:function(b,h,l){h.data("event-id",b.id);h.attr("data-event-id",b.id);h.data("event-start",b.start.format("YYYY-MM-DD HH:mm:ss"));h.attr("data-event-start",b.start.format("YYYY-MM-DD HH:mm:ss"));h.data("event-end",b.end.format("YYYY-MM-DD HH:mm:ss"));h.attr("data-event-end",b.end.format("YYYY-MM-DD HH:mm:ss"));b.render=1;if(b.activity_id!=null){h.data("activity-id",b.activity_id);h.attr("data-activity-id",b.activity_id)}if(l.name.indexOf("basic")>-1||l.name.indexOf("month")>-1){h.find("span.fc-time").text(b.start.format("HH:mm")+" - "+b.end.format("HH:mm"))}b.bookings=bookacti_get_event_number_of_bookings(b,"bookacti-template-calendar");if(b.bookings!=null&&b.availability!=null){var o="",p="",m="";if(parseInt(b.availability)===0){o="bookacti-no-availability"}else{if(parseInt(b.bookings)>0){p="bookacti-booked"}else{p="bookacti-not-booked"}if(parseInt(b.bookings)>=parseInt(b.availability)){m="bookacti-full"}}var j='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+o+" "+p+" "+m+'" ><span class="bookacti-bookings" >'+b.bookings+'</span><span class="bookacti-total-availability" >/'+b.availability+"</span></span></div>";h.append(j)}var c=h.find(".bookacti-event-actions").length>0?h.find(".bookacti-event-actions"):$j("<div />",{"class":"bookacti-event-actions"});var f=[];if(!c.find(".bookacti-event-action-edit").length){var i=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-edit","data-hide-on-mouseout":"1"});var d=$j("<span />",{type:"checkbox","class":"dashicons dashicons-admin-generic bookacti-event-action-edit-button","aria-hidden":"true"});f.push(i.prepend(d))}if(!c.find(".bookacti-event-action-select").length){var e=false;$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(r,q){if(q.id==b.id&&q.start.substr(0,10)===b.start.format("YYYY-MM-DD")){e=true;return false}});var n=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-select","data-hide-on-mouseout":"0"});var k=$j("<input />",{type:"checkbox","class":"bookacti-event-action-select-checkbox",value:"0",checked:e});f.push(n.append(k))}$j.each(f,function(r,q){c.append(q)});a.trigger("bookacti_event_actions",[c,b,h,l]);h.append(c);if(l.name==="month"||l.name==="basicWeek"||l.name==="basicDay"){var g=$j("<div />",{"class":"fc-bg"});h.append(g)}if(b.repeat_freq){if(b.repeat_freq!=="none"){if(bookacti.booking_system["bookacti-template-calendar"]["exceptions"]!==undefined&&bookacti.booking_system["bookacti-template-calendar"]["exceptions"][b.id]!==undefined){$j.each(bookacti.booking_system["bookacti-template-calendar"]["exceptions"][b.id],function(q,r){if(r.exception_type==="date"&&r.exception_value===b.start.format("YYYY-MM-DD")){b.render=0}})}}}if(bookacti.hidden_activities!=null&&b.activity_id!=null){$j.each(bookacti.hidden_activities,function(r,q){if(parseInt(b.activity_id)===q){h.addClass("event-exception");b.render=0}})}a.trigger("bookacti_event_render",[b,h,l]);if(!b.render){return false}},eventAfterRender:function(d,c,b){bookacti_add_class_according_to_event_size(c)},eventAfterAllRender:function(b){if(bookacti.blocked_events===true){$j(".fc-event").addClass("bookacti-event-unavailable")}else{if($j.isNumeric(bookacti.blocked_events)){$j('.fc-event[data-event-id="'+bookacti.blocked_events+'"]').addClass("bookacti-event-unavailable")}else{$j(".fc-event").removeClass("bookacti-event-unavailable")}}$j(".fc-event.event-exception").remove();$j('.bookacti-event-action[data-hide-on-mouseout="1"]').hide();$j.each(bookacti.booking_system["bookacti-template-calendar"]["picked_events"],function(c,d){a.find('.fc-event[data-event-id="'+d.id+'"][data-event-start="'+d.start+'"]').addClass("bookacti-picked-event")});bookacti_refresh_selected_events_display()},eventReceive:function(b){b.end=moment(b.start);var i=b.title;var m=0;var g=0;var h="000.00:00:00";var c=0;$j("#bookacti-template-activities-container .fc-event").each(function(){if($j(this).html()===i){i=$j(this).data("title");m=$j(this).data("activity-id");g=$j(this).data("availability");h=$j(this).data("duration");c=$j(this).data("resizable")}});var l=parseInt(h.substr(0,3));var j=parseInt(h.substr(4,5));var f=parseInt(h.substr(7,8));var k=parseInt(h.substr(10,11));b.end.add({d:l,h:j,m:f,s:k});if(parseInt(c)===1){b.durationEditable=true}var d=b.start.format("YYYY-MM-DD HH:mm:ss");var e=b.end.format("YYYY-MM-DD HH:mm:ss");bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiInsertEvent",activity_id:m,template_id:bookacti.selected_template,event_title:i,event_start:d,event_end:e,event_availability:g,nonce:bookacti_localized.nonce_insert_event},type:"POST",dataType:"json",success:function(n){if(n.status==="success"){b.id=n.eventid;b.activity_id=m;if(!m){b.activity_id=0}b.availability=g;if(!g){b.availability=0}b.bookings=0;a.fullCalendar("updateEvent",b)}else{if(b._id!==undefined){if(b._id.indexOf("_")>=0){a.fullCalendar("removeEvents",b._id)}}a.fullCalendar("removeEvents",b.id);a.fullCalendar("refetchEvents");var o=bookacti_localized.error_insert_event;if(n.error==="not_allowed"){o+="\n"+bookacti_localized.error_not_allowed}alert(o);console.log(n)}},error:function(n){alert("AJAX "+bookacti_localized.error_insert_event);console.log(n)},complete:function(){bookacti_stop_template_loading()}})},eventResize:function(e,h,d){var g=e.id;var f=e.start.format("YYYY-MM-DD HH:mm:ss");var b=e.end.format("YYYY-MM-DD HH:mm:ss");var c=h._days;bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiResizeEvent",delta_days:c,event_id:g,event_start:f,event_end:b,nonce:bookacti_localized.nonce_move_or_resize_event},type:"POST",dataType:"json",success:function(i){if(i.status==="success"){var j=e.end.format("HH:mm:ss");$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(n,m){if(m.id==e.id){var l=moment(m.end).add(c,"days").format("YYYY-MM-DD")+" "+j;m.end=l}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(l,m){$j.each(m,function(o,p){if(p.id==e.id){var n=moment(p.end).add(c,"days").format("YYYY-MM-DD")+" "+j;p.end=n}})})}else{if(i.status==="failed"){d();if(i.error==="has_bookings"){if(!e.bookings){bookacti_refresh_booking_numbers(bookacti.selected_template,e.id)}if(e.repeat_freq!=="none"){bookacti_dialog_unbind_occurences(e,["resize"])}}else{var k=bookacti_localized.error_resize_event;if(i.error==="not_allowed"){k+="\n"+bookacti_localized.error_not_allowed}else{if(i.error==="has_bookings"){bookacti_refresh_booking_numbers(bookacti.selected_template,e.id);k+="\n"+bookacti_localized.error_edit_locked_event;k+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(k);console.log(i)}}}},error:function(i){d();alert("AJAX "+bookacti_localized.error_resize_event);console.log(i)},complete:function(){bookacti_stop_template_loading()}})},eventDrop:function(b,k,i,h){var c=0;if(h.altKey){c=1}if(c){i()}var d=b.id;var f=b.start.format("YYYY-MM-DD HH:mm:ss");var g=(b.end===null)?f:b.end.format("YYYY-MM-DD HH:mm:ss");var j=k._days;bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiMoveEvent",delta_days:j,event_id:d,event_start:f,event_end:g,is_duplicated:c,nonce:bookacti_localized.nonce_move_or_resize_event},type:"POST",dataType:"json",success:function(e){if(e.status==="success"){var p=b.start.format("HH:mm:ss");var n=b.end.format("HH:mm:ss");if(c){var m=e.event_id;var l={};bookacti.booking_system["bookacti-template-calendar"]["exceptions"][m]=e.exceptions[m];if(b.repeat_freq&&b.repeat_freq!=="none"){$j.extend(bookacti.booking_system["bookacti-template-calendar"]["events"]["repeated"],e.events.repeated);l=bookacti_get_repeated_events_sources("bookacti-template-calendar",e.events.repeated)}else{$j.extend(bookacti.booking_system["bookacti-template-calendar"]["events"]["single"],e.events.single);l=bookacti_get_single_events_sources("bookacti-template-calendar",e.events.single)}$j.each(l,function(q,r){$j("#bookacti-template-calendar").fullCalendar("addEventSource",r)});return false}$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(s,r){if(r.id==b.id){var t=moment(r.start).add(j,"days").format("YYYY-MM-DD")+" "+p;var q=moment(r.end).add(j,"days").format("YYYY-MM-DD")+" "+n;r.start=t;r.end=q}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(q,r){$j.each(r,function(t,v){if(v.id==b.id){var u=moment(v.start).add(j,"days").format("YYYY-MM-DD")+" "+p;var s=moment(v.end).add(j,"days").format("YYYY-MM-DD")+" "+n;v.start=u;v.end=s}})})}else{if(e.status==="failed"){i();if(e.error==="has_bookings"){if(!b.bookings){bookacti_refresh_booking_numbers(bookacti.selected_template,b.id)}if(b.repeat_freq!=="none"){bookacti_dialog_unbind_occurences(b,["move"])}}else{var o=bookacti_localized.error_move_event;if(e.error==="not_allowed"){o+="\n"+bookacti_localized.error_not_allowed}else{if(e.error==="has_bookings"){bookacti_refresh_booking_numbers(bookacti.selected_template,b.id);o+="\n"+bookacti_localized.error_edit_locked_event;o+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(o);console.log(e)}}}},error:function(l){i();alert("AJAX "+bookacti_localized.error_move_event);console.log(l)},complete:function(){bookacti_stop_template_loading()}})},eventDragStart:function(d,c,e,b){bookacti.is_dragging=true},eventDragStop:function(d,c,e,b){bookacti.is_dragging=false},eventClick:function(e,c,b){var d=$j(this);var f=$j('.fc-event[data-event-id="'+e.id+'"][data-event-start="'+e.start.format("YYYY-MM-DD HH:mm:ss")+'"]');if(bookacti.is_touch_device){if(!d.find(".bookacti-event-action").is(":visible")){$j(".bookacti-event-over").removeClass("bookacti-event-over");bookacti_show_event_actions(d)}else{bookacti_hide_event_actions(d,e)}}$j(".fc-event").removeClass("bookacti-picked-event");f.addClass("bookacti-picked-event");bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"].push({id:e.id,activity_id:e.activity_id,start:e.start.format("YYYY-MM-DD HH:mm:ss"),end:e.end.format("YYYY-MM-DD HH:mm:ss")});if($j(c.target).parents(".bookacti-event-actions").length){if($j(c.target).is(".bookacti-event-action-edit")||$j(c.target).parents(".bookacti-event-action-edit").length){if(e.editable!==false){bookacti_dialog_update_event(e)}}else{if($j(c.target).is(".bookacti-event-action-select")||$j(c.target).parents(".bookacti-event-action-select").length){if(d.find(".bookacti-event-action-select-checkbox").is(":checked")){bookacti_select_event(e)}else{bookacti_unselect_event(e);d.find(".bookacti-event-action-select").show()}}}}a.trigger("bookacti_pick_event",[e,c,b])},eventMouseover:function(e,c,b){var d=$j(this);bookacti_show_event_actions(d)},eventMouseout:function(e,c,b){var d=$j(this);bookacti_hide_event_actions(d,e)},loading:function(b){if(!b&&bookacti.is_touch_device){$j(".fc-event").each(function(){var c=$j.Event("mouseover",{target:this.firstChild,_dummyCalledOnStartup:true});$j(this).trigger(c)})}}})};