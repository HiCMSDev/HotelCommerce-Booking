$j(document).ready(function(){if($j("#bookacti-template-calendar").length||$j("#bookacti-first-template-container").length){bookacti.selected_template=parseInt($j("#bookacti-template-picker").val())||0;bookacti.hidden_activities=[];bookacti.selected_category="new";bookacti.is_dragging=false;bookacti.is_resizing=false;bookacti.blocked_events=false;bookacti.load_events=false;bookacti.booking_system["bookacti-template-calendar"]={};bookacti.booking_system["bookacti-template-calendar"]["calendars"]=bookacti.selected_template?[bookacti.selected_template]:[];bookacti.booking_system["bookacti-template-calendar"]["bookings"]=[];bookacti.booking_system["bookacti-template-calendar"]["exceptions"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["groups_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["activities_data"]={};bookacti.booking_system["bookacti-template-calendar"]["events_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["events_interval"]=[];bookacti.booking_system["bookacti-template-calendar"]["group_categories_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]=[];bookacti.booking_system["bookacti-template-calendar"]["template_data"]={start:$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-start")||false,end:$j('#bookacti-template-picker option[value="'+bookacti.selected_template+'"]').data("template-end")||false};bookacti.booking_system["bookacti-template-calendar"]["selected_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["loading_number"]=0;bookacti.booking_system["bookacti-template-calendar"]["method"]="calendar";bookacti.booking_system["bookacti-template-calendar"]["past_events"]=true;bookacti.booking_system["bookacti-template-calendar"]["past_events_bookable"]=true;bookacti_init_activities();bookacti_init_groups_of_events();bookacti_init_show_hide_activities_switch();bookacti_init_template_dialogs();bookacti_bind_template_dialogs();$j("#bookacti-template-picker").on("change",function(){bookacti_switch_template($j(this).val())});if($j("#bookacti-template-calendar").length){bookacti_load_template_calendar($j("#bookacti-template-calendar"))}if(bookacti.selected_template){bookacti_switch_template(bookacti.selected_template)}$j("#bookacti-template-activities-container").on("dragstart",".fc-event",function(a,b){b.helper.css("maxWidth",$j(this).width())});window.onerror=function(e,b,a,d,c){$j("#bookacti-fatal-error").show()};$j("#bookacti-exit-loading").on("click",function(){bookacti_exit_template_loading_state(true);bookacti.load_events=true})}});function bookacti_load_template_calendar(f){f=f||$j("#bookacti-template-calendar");var c=bookacti_get_availability_period(f,true);var d=typeof bookacti.booking_system["bookacti-template-calendar"]["template_data"]["settings"]!=="undefined"?bookacti.booking_system["bookacti-template-calendar"]["template_data"]["settings"]:{};var a=typeof d.minTime!=="undefined"?d.minTime:"00:00";var b=typeof d.maxTime!=="undefined"?(d.maxTime==="00:00"?"24:00":d.maxTime):"24:00";var g=typeof d.snapDuration!=="undefined"?d.snapDuration:"00:05";var e={locale:bookacti_localized.fullcalendar_locale,defaultView:"agendaWeek",minTime:a,maxTime:b,slotLabelFormat:"LT",slotDuration:"00:30",snapDuration:g,scrollTime:"00:00",validRange:{start:moment(c.start),end:moment(c.end).add(1,"days")},nowIndicator:0,weekNumbers:0,weekNumbersWithinDays:1,navLinks:0,slotEventOverlap:0,eventLimit:2,eventLimitClick:"popover",showNonCurrentDates:0,allDaySlot:false,allDayDefault:false,fixedWeekCount:false,showNonCurrentDates:false,editable:true,droppable:true,dropAccept:".fc-event",eventDurationEditable:false,dragRevertDuration:0,header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:function(k,h,i,j){j([])},viewRender:function(h){if(bookacti.load_events===true){var i={start:moment.utc(h.intervalStart),end:moment.utc(h.intervalEnd).subtract(1,"days")};bookacti_fetch_events_from_interval($j("#bookacti-template-calendar"),i)}if(h.name==="agendaWeek"||h.name==="agendaDay"){f.fullCalendar("option","contentHeight","auto")}else{f.fullCalendar("option","contentHeight",null)}},eventRender:function(x,k,v){if(bookacti.is_dragging||bookacti.is_resizing){return true}var q=bookacti.booking_system["bookacti-template-calendar"]["events_data"][x.id];k.data("event-id",x.id);k.attr("data-event-id",x.id);k.data("event-start",x.start.format("YYYY-MM-DD HH:mm:ss"));k.attr("data-event-start",x.start.format("YYYY-MM-DD HH:mm:ss"));k.data("event-end",x.end.format("YYYY-MM-DD HH:mm:ss"));k.attr("data-event-end",x.end.format("YYYY-MM-DD HH:mm:ss"));x.render=1;if(typeof q!=="undefined"&&q.activity_id){var t=q.activity_id;k.data("activity-id",t);k.attr("data-activity-id",t)}var A=k.find(".fc-title");A.html(A.text());var m="LT";if(v.name.indexOf("agenda")>-1){m=f.fullCalendar("option","noMeridiemTimeFormat")}k.find(".fc-time").html('<span class="bookacti-event-time-start">'+x.start.format(m)+'</span><span class="bookacti-event-time-separator"> - </span><span class="bookacti-event-time-end">'+x.end.format(m)+"</span>");if(typeof q!=="undefined"&&q.availability){var u=parseInt(q.availability);x.bookings=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),x);if(x.bookings!=null){var r="",h="",j="";if(u===0){r="bookacti-no-availability"}else{if(x.bookings>0){h="bookacti-booked"}else{h="bookacti-not-booked"}if(x.bookings>=u){j="bookacti-full"}}var i='<div class="bookacti-availability-container" ><span class="bookacti-available-places '+r+" "+h+" "+j+'" ><span class="bookacti-bookings" >'+x.bookings+'</span><span class="bookacti-total-availability" >/'+u+"</span></span></div>";k.append(i)}}var s=k.find(".bookacti-event-actions").length>0?k.find(".bookacti-event-actions"):$j("<div />",{"class":"bookacti-event-actions"});var y=[];if(!s.find(".bookacti-event-action-edit").length){var l=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-edit","data-hide-on-mouseout":"1"});var p=$j("<span />",{type:"checkbox","class":"dashicons dashicons-admin-generic bookacti-event-action-edit-button","aria-hidden":"true"});y.push(l.prepend(p))}if(!s.find(".bookacti-event-action-select").length){var w=false;$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(C,B){if(B.id==x.id&&B.start.substr(0,10)===x.start.format("YYYY-MM-DD")){w=true;return false}});var z=$j("<div />",{"class":"bookacti-event-action bookacti-event-action-select","data-hide-on-mouseout":"0"});var o=$j("<input />",{type:"checkbox","class":"bookacti-event-action-select-checkbox",value:"0",checked:w});y.push(z.append(o))}$j.each(y,function(C,B){s.append(B)});f.trigger("bookacti_event_actions",[s,x,k,v]);k.append(s);if(v.name==="month"||v.name==="basicWeek"||v.name==="basicDay"){var n=$j("<div />",{"class":"fc-bg"});k.append(n)}if(typeof q!=="undefined"&&q.repeat_freq){if(q.repeat_freq!=="none"){if(bookacti.booking_system["bookacti-template-calendar"]["exceptions"]!==undefined&&bookacti.booking_system["bookacti-template-calendar"]["exceptions"][x.id]!==undefined){$j.each(bookacti.booking_system["bookacti-template-calendar"]["exceptions"][x.id],function(B,C){if(C.exception_type==="date"&&C.exception_value===x.start.format("YYYY-MM-DD")){x.render=0}})}}}if(bookacti.hidden_activities!=null&&t!=null){$j.each(bookacti.hidden_activities,function(C,B){if(parseInt(t)===B){k.addClass("event-exception");x.render=0}})}f.trigger("bookacti_event_render",[x,k,v]);if(!x.render){return false}},eventAfterRender:function(j,i,h){bookacti_add_class_according_to_event_size(i)},eventAfterAllRender:function(h){if(bookacti.blocked_events===true){$j(".fc-event").addClass("bookacti-event-unavailable")}else{if($j.isNumeric(bookacti.blocked_events)){$j('.fc-event[data-event-id="'+bookacti.blocked_events+'"]').addClass("bookacti-event-unavailable")}else{$j(".fc-event").removeClass("bookacti-event-unavailable")}}$j(".fc-event.event-exception").remove();$j('.bookacti-event-action[data-hide-on-mouseout="1"]').hide();$j.each(bookacti.booking_system["bookacti-template-calendar"]["picked_events"],function(j,k){f.find('.fc-event[data-event-id="'+k.id+'"][data-event-start="'+k.start+'"]').addClass("bookacti-picked-event")});bookacti_refresh_selected_events_display()},eventReceive:function(k){var j=parseInt(k.activity_id);var l=bookacti.booking_system["bookacti-template-calendar"]["activities_data"][j];var i=f.fullCalendar("getView");if(!l){return false}if(i.name.substr(0,6)!=="agenda"){var h=f.fullCalendar("option","minTime");k.start.set({hours:h.substr(0,2),minutes:h.substr(3,2),seconds:0})}k.end=k.start.clone();k.end.add(moment.duration(l.duration));if(parseInt(l.is_resizable)===1){k.durationEditable=true}bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiInsertEvent",activity_id:j,template_id:bookacti.selected_template,event_title:l.multilingual_title,event_start:k.start.format("YYYY-MM-DD HH:mm:ss"),event_end:k.end.format("YYYY-MM-DD HH:mm:ss"),event_availability:l.availability,nonce:bookacti_localized.nonce_insert_event},type:"POST",dataType:"json",success:function(m){if(m.status==="success"){k.id=m.event_id;k.bookings=0;bookacti.booking_system["bookacti-template-calendar"]["events_data"][k.id]=m.event_data;f.fullCalendar("updateEvent",k)}else{if(k._id!==undefined){if(k._id.indexOf("_")>=0){f.fullCalendar("removeEvents",k._id)}}f.fullCalendar("removeEvents",k.id);f.fullCalendar("refetchEvents");var n=bookacti_localized.error_insert_event;if(m.error==="not_allowed"){n+="\n"+bookacti_localized.error_not_allowed}alert(n);console.log(m)}},error:function(m){alert("AJAX "+bookacti_localized.error_insert_event);console.log(m)},complete:function(){bookacti_stop_template_loading()}})},eventResize:function(i,p,n){var h={id:i.id,start:i.start.clone(),end:i.end.clone().subtract(p._data),};var q=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),h);if(q>0){n();var l=bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none";if(l){bookacti_dialog_unbind_occurences(i,["resize"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}var j=i.id;var k=i.start.format("YYYY-MM-DD HH:mm:ss");var m=i.end.format("YYYY-MM-DD HH:mm:ss");var o=p._days;bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiResizeEvent",delta_days:o,event_id:j,event_start:k,event_end:m,nonce:bookacti_localized.nonce_move_or_resize_event},type:"POST",dataType:"json",success:function(r){if(r.status==="success"){var s=i.end.format("HH:mm:ss");$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(w,v){if(v.id==i.id){var u=moment(v.end).add(o,"days").format("YYYY-MM-DD")+" "+s;v.end=u}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(u,v){$j.each(v,function(x,y){if(y.id==i.id){var w=moment(y.end).add(o,"days").format("YYYY-MM-DD")+" "+s;y.end=w}})})}else{if(r.status==="failed"){n();if(r.error==="has_bookings"){if(!i.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurences(i,["resize"])}}var t=bookacti_localized.error_resize_event;if(r.error==="not_allowed"){t+="\n"+bookacti_localized.error_not_allowed}else{if(r.error==="has_bookings"){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id);t+="\n"+bookacti_localized.error_edit_locked_event;t+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(t);console.log(r)}}},error:function(r){n();alert("AJAX "+bookacti_localized.error_resize_event);console.log(r)},complete:function(){bookacti_stop_template_loading()}})},eventDrop:function(i,s,q,p){var j=0;if(p.altKey){j=1}if(j){q()}else{var h={id:i.id,start:i.start.clone().subtract(s._data),end:i.end.clone().subtract(s._data),};var t=bookacti_get_event_number_of_bookings($j("#bookacti-template-calendar"),h);if(t>0){q();var n=bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none";if(n){bookacti_dialog_unbind_occurences(i,["move"])}else{alert(bookacti_localized.error_edit_locked_event)}return false}}var l=i.id;var k=i.start.format("YYYY-MM-DD HH:mm:ss");var o=(i.end===null)?k:i.end.format("YYYY-MM-DD HH:mm:ss");var r=s._days;var m=bookacti.booking_system["bookacti-template-calendar"]["events_interval"];bookacti_start_template_loading();$j.ajax({url:ajaxurl,data:{action:"bookactiMoveEvent",delta_days:r,event_id:l,event_start:k,event_end:o,interval:m,is_duplicated:j,nonce:bookacti_localized.nonce_move_or_resize_event},type:"POST",dataType:"json",success:function(u){if(u.status==="success"){if(j){var v=u.event_id;if(typeof u.exceptions[v]!=="undefined"){bookacti.booking_system["bookacti-template-calendar"]["exceptions"][v]=u.exceptions[v]}if(!$j.isEmptyObject(u.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][v]=u.event_data}$j("#bookacti-template-calendar").fullCalendar("addEventSource",u.events);return false}var y=i.start.format("HH:mm:ss");var w=i.end.format("HH:mm:ss");if(!$j.isEmptyObject(u.event_data)){bookacti.booking_system["bookacti-template-calendar"]["events_data"][l]=u.event_data}$j.each(bookacti.booking_system["bookacti-template-calendar"]["selected_events"],function(B,A){if(A.id==i.id){var C=moment(A.start).add(r,"days").format("YYYY-MM-DD")+" "+y;var z=moment(A.end).add(r,"days").format("YYYY-MM-DD")+" "+w;A.start=C;A.end=z}});$j.each(bookacti.booking_system["bookacti-template-calendar"]["groups_events"],function(z,A){$j.each(A,function(C,E){if(E.id==i.id){var D=moment(E.start).add(r,"days").format("YYYY-MM-DD")+" "+y;var B=moment(E.end).add(r,"days").format("YYYY-MM-DD")+" "+w;E.start=D;E.end=B}})});if(u.events.length>0){$j("#bookacti-template-calendar").fullCalendar("removeEvents",l);$j("#bookacti-template-calendar").fullCalendar("addEventSource",u.events)}}else{if(u.status==="failed"){q();if(u.error==="has_bookings"){if(!i.bookings){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id)}if(bookacti.booking_system["bookacti-template-calendar"]["events_data"][i.id]["repeat_freq"]!=="none"){bookacti_dialog_unbind_occurences(i,["move"])}}var x=bookacti_localized.error_move_event;if(u.error==="not_allowed"){x+="\n"+bookacti_localized.error_not_allowed}else{if(u.error==="has_bookings"){bookacti_refresh_booking_numbers($j("#bookacti-template-calendar"),i.id);x+="\n"+bookacti_localized.error_edit_locked_event;x+="\n"+bookacti_localized.advice_switch_to_maintenance+"\n"}}alert(x);console.log(u)}}},error:function(u){q();alert("AJAX "+bookacti_localized.error_move_event);console.log(u)},complete:function(){bookacti_stop_template_loading()}})},eventDragStart:function(j,i,k,h){bookacti.is_dragging=true},eventDragStop:function(j,i,k,h){bookacti.is_dragging=false},eventResizeStart:function(j,i,k,h){bookacti.is_resizing=true},eventResizeStop:function(j,i,k,h){bookacti.is_resizing=false},eventClick:function(k,i,h){var j=$j(this);var l=$j('.fc-event[data-event-id="'+k.id+'"][data-event-start="'+k.start.format("YYYY-MM-DD HH:mm:ss")+'"]');if(bookacti.is_touch_device){if(!j.find(".bookacti-event-action").is(":visible")){$j(".bookacti-event-over").removeClass("bookacti-event-over");bookacti_show_event_actions(j)}else{bookacti_hide_event_actions(j,k)}}$j(".fc-event").removeClass("bookacti-picked-event");l.addClass("bookacti-picked-event");bookacti.booking_system["bookacti-template-calendar"]["picked_events"]=[];bookacti.booking_system["bookacti-template-calendar"]["picked_events"].push({id:k.id,start:k.start.format("YYYY-MM-DD HH:mm:ss"),end:k.end.format("YYYY-MM-DD HH:mm:ss")});if($j(i.target).parents(".bookacti-event-actions").length){if($j(i.target).is(".bookacti-event-action-edit")||$j(i.target).parents(".bookacti-event-action-edit").length){if(k.editable!==false){bookacti_dialog_update_event(k)}}else{if($j(i.target).is(".bookacti-event-action-select")||$j(i.target).parents(".bookacti-event-action-select").length){if(j.find(".bookacti-event-action-select-checkbox").is(":checked")){bookacti_select_event(k)}else{bookacti_unselect_event(k);j.find(".bookacti-event-action-select").show()}}}}f.trigger("bookacti_pick_event",[k,i,h])},eventMouseover:function(k,i,h){var j=$j(this);bookacti_show_event_actions(j)},eventMouseout:function(k,i,h){var j=$j(this);bookacti_hide_event_actions(j,k)},loading:function(h){if(!h&&bookacti.is_touch_device){$j(".fc-event").each(function(){var i=$j.Event("mouseover",{target:this.firstChild,_dummyCalledOnStartup:true});$j(this).trigger(i)})}}};f.trigger("bookacti_calendar_editor_init_data",[e]);f.fullCalendar(e);if(typeof bookacti.booking_system["bookacti-template-calendar"]["events"]!=="undefined"){if(bookacti.booking_system["bookacti-template-calendar"]["events"].length){f.fullCalendar("addEventSource",bookacti.booking_system["bookacti-template-calendar"]["events"])}}};